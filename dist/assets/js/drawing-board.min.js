let canvas=document.getElementById("drawingCanvas"),ctx=canvas.getContext("2d"),colorPicker=document.getElementById("colorPicker"),brushSizeSlider=document.getElementById("brushSize"),brushSizeValueSpan=document.getElementById("brushSizeValue"),clearButton=document.getElementById("clearButton"),saveButton=document.getElementById("saveButton"),drawingObservationTextarea=document.getElementById("drawingObservation"),undoButton=document.getElementById("undoButton"),isDrawing=!1,lastX=0,lastY=0,history=[],drawingsGallery=document.getElementById("drawings-gallery");function saveState(){history.push(canvas.toDataURL())}function restoreState(e){let t=new Image;t.onload=function(){ctx.clearRect(0,0,canvas.width,canvas.height),ctx.drawImage(t,0,0)},t.src=e}canvas.width=canvas.parentElement.clientWidth,canvas.height=400,ctx.lineJoin="round",ctx.lineCap="round",ctx.lineWidth=brushSizeSlider.value,ctx.strokeStyle=colorPicker.value,brushSizeValueSpan.textContent=brushSizeSlider.value,canvas.addEventListener("mousedown",e=>{isDrawing=!0,[lastX,lastY]=[e.offsetX,e.offsetY]}),canvas.addEventListener("mousemove",e=>{isDrawing&&(ctx.beginPath(),ctx.moveTo(lastX,lastY),ctx.lineTo(e.offsetX,e.offsetY),ctx.stroke(),[lastX,lastY]=[e.offsetX,e.offsetY])}),canvas.addEventListener("mouseup",()=>{isDrawing&&saveState(),isDrawing=!1}),canvas.addEventListener("mouseout",()=>{isDrawing&&saveState(),isDrawing=!1}),colorPicker.addEventListener("input",e=>{ctx.strokeStyle=e.target.value}),brushSizeSlider.addEventListener("input",e=>{ctx.lineWidth=e.target.value,brushSizeValueSpan.textContent=e.target.value}),clearButton.addEventListener("click",()=>{ctx.clearRect(0,0,canvas.width,canvas.height),history=[],saveState()});let isCanvasBlank=e=>{var t=document.createElement("canvas");return t.width=e.width,t.height=e.height,e.toDataURL()===t.toDataURL()};function loadDrawings(){var e=JSON.parse(localStorage.getItem("drawings"))||[];drawingsGallery.innerHTML="",e.forEach((e,t)=>{var a,n=document.createElement("div"),r=(n.classList.add("col-md-4","mb-4"),n.dataset.index=t,n.classList.add("card"),document.createElement("img")),t=(r.src=e.dataURL,r.alt="Dibujo guardado "+(t+1),r.classList.add("img-fluid"),document.createElement("div"));t.style.position="relative",t.classList.add("card-img-top"),t.appendChild(r);let s=document.createElement("button");s.textContent="x",s.addEventListener("click",()=>{var e=JSON.parse(localStorage.getItem("drawings"))||[],t=s.parentElement.parentElement,t=Array.from(drawingsGallery.children).indexOf(t);e.splice(t,1),localStorage.setItem("drawings",JSON.stringify(e)),loadDrawings()}),s.classList.add("btn","btn-danger","btn-sm","position-absolute","top-0","end-0","m-2"),t.appendChild(s),n.appendChild(t),e.observation&&""!==e.observation.trim()?((r=document.createElement("div")).classList.add("card-body"),(a=document.createElement("textarea")).classList.add("form-control","observation-box"),a.rows=3,a.value=e.observation.trim(),a.readOnly=!0,a.style.minHeight="50px",r.appendChild(a),n.appendChild(r),n.style.border="1px solid var(--secondary-color)",n.style.borderRadius="5px",n.style.padding="10px",n.style.boxShadow="0 2px 4px rgba(0, 0, 0, 0.1)"):(n.classList.add("no-text"),t.style.border="1px solid var(--secondary-color)",t.style.borderRadius="5px",t.style.padding="10px",t.style.boxShadow="0 2px 4px rgba(0, 0, 0, 0.1)"),drawingsGallery.appendChild(n)})}saveButton.addEventListener("click",()=>{var e=canvas.toDataURL(),t=drawingObservationTextarea.value,a=(console.log("Generated Data URL:",e),JSON.parse(localStorage.getItem("drawings"))||[]);isCanvasBlank(canvas)&&""===t.trim()?alert("Debes hacer un dibujo o añadir una observación antes de guardar."):(a.push({dataURL:e,observation:t}),localStorage.setItem("drawings",JSON.stringify(a)),loadDrawings(),drawingObservationTextarea.value="",ctx.clearRect(0,0,canvas.width,canvas.height),alert("Dibujo guardado (temporalmente en tu navegador)!"))}),undoButton.addEventListener("click",()=>{1<history.length?(history.pop(),restoreState(history[history.length-1])):1===history.length&&(ctx.clearRect(0,0,canvas.width,canvas.height),history=[],saveState())}),window.addEventListener("resize",()=>{var e=ctx.lineWidth,t=ctx.strokeStyle,a=canvas.toDataURL();canvas.width=canvas.parentElement.clientWidth,canvas.height=400,ctx.lineJoin="round",ctx.lineCap="round",ctx.lineWidth=e,ctx.strokeStyle=t,a&&restoreState(a)}),saveState(),document.addEventListener("DOMContentLoaded",loadDrawings);